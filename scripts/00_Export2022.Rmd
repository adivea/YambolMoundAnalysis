---
title: "AKB prep"
author: "Adela Sobotkova"
date: "2022-12-27"
output: html_document
---
```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(formatR)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

## Wrangling Mound data out of FAIMS data

The purpose of this script is to clean up and filter the total aggregate of FAIMS data originating from the Yambol region to mostly-mound points from within the regional boundary, whose attributes are analysis-ready.

## Setup
```{r libraries}
library(tidyverse)
library(sf)
```


## Load data
```{r -load-aggr-data}
mounds22 <- read_csv("../data/2022Elhovo.csv")
mnd22 <- mounds22 %>%
  dplyr::rename(TRAP=MoundID, Type=TypeClean, LU_Around = LanduseAroundMound, LU_Top = LanduseOnTopOfMound) %>% 
  dplyr::select(TRAP, Source, Type, LU_Around, LU_Top, DiameterMax, HeightMax, Condition, PrincipalSourceOfImpact, Date, Northing, Easting, geospatialcolumn)
#colnames(features)

# check for missing coordinates
which(is.na(mnd22$geospatialcolumn))

# convert to a simple feature
mn22 <- st_as_sf(mnd22, coords = c("Easting", "Northing"), crs = 32635)

# sanity check
library(mapview)
mapview(mn22, zcol = 'Type')
```

## Add data necessary for 2022 campaign AKB NEEDS REWORK WITH NEW 2022 DATA!
### Distance from each mound to its "zemlishte"

AKB asks for distance and azimuth to the nearest cadastral village (in "zemlishte"). The tricky part is that the cadastral villages need not be the geographically nearest places, and so we need to know which zemlishte territory is each mound in so we can calculate the distance between it and all the mounds in the village cadastre.

The information about which village cadastre does a mound belong to can be derived from an intersection of the mounds and zemlishte polygons. Here we use a shortcut: spatial points output from a spatial query in ArcGIS (ElhStr_features.shp), which contains the TRAP ID of each mound and the Name and number of the zemlishte village (Name_en and EKATTE)
We have the zemlishte village point data with Name_en and EKATTE in ElhStr_towns shapefile

```{r load-zemlishe}
# Zemlishte information sit in ElhStr_towns shapefile
village <- read_sf("../data/ElhStr_towns.shp")
data22 <- read_sf("../data/ElhStr_features.shp")
```

### Wrangle the features and nearest zemlishte 
```{r wrangle-zemlishte}
# Subset the features 2022 data to only TRAP numbers and the name of the  zemlishte-defining village
features22 <- data22 %>%
  dplyr::select(TRAP,EKATTE, Name_en) #EKATTE and Name_en are the number and name of the zemlishte that we are interested in

# Create a simple feature of village points ordered by the TRAP numbers from the features 22 dataset,   
villages22 <- features22 %>% 
  st_drop_geometry() %>%  # dropping feature geometry
  left_join(village, by = "EKATTE") %>%  #joining village geometry to TRAP numbers
  dplyr::select(-Descr_bg, -Name_bg, -Suffix_bg, -Suffix_en)
villages22
```

### Calculate distances

Once we have the starting and ending points, the distances are trivial to calculate between mounds and zemlishte using the st_distance() function, utilizing by_element argument, because I am only interested in pairwise distances 
```{r distance-zemlishte}
features22$distToTown <- st_distance(features22$geometry, villages22$geometry, by_element = TRUE)
ls('package:sf')
```

### Calculate azimuth

Azimuth can be tricky as it is an angular measurement which is often produced only in geographic space and here we have geometric, planar space. I use the `nngeo` package of Michael Dorman as it calculates "planar" /geometric azimuth (https://michaeldorman.github.io/nngeo/index.html).
sf library works in geometric /planar space and so 
The other `geosphere::azimuth` which calculates geographic azimuth in `latlong` coordinates.(https://stackoverflow.com/questions/51030060/in-geosphere-package-in-r-why-arent-bearings-in-0-360-degrees) 


```{r azimuth}
install.packages("remotes")
remotes::install_github("michaeldorman/nngeo")
features22$azimuth <- nngeo::st_azimuth(features22$geometry, villages22$geometry)
```

### Export for Toshko
```{r export}
# All 479 features from the Elhovo and Straldzha municipality (2010-2022)
write.csv(features22 %>% st_drop_geometry(), "../output_data/features22forToshko.csv")

# Only 238 features collected in 2022 in the Elhovo and Straldzha municipality
library(mapview)
features22 %>% 
  filter(TRAP %in%mnd22$TRAP) %>% 
  mapview()

# Only 311 features collected in 2010-2022 in the Elhovo municipality
mun <- read_sf("../data/Yam_Municipalities.shp")

library(sf)
features22$geometry %>% 
  sf::st_intersection(mun[4,]) %>% 
  mapview()
```
