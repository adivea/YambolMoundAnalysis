---
title: "Bronze Age mounds - Are they different?"
author: "Adela Sobotkova"
date: "2022-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
```

## Load 2009-2022 data
```{r load-mounds}
# Yambol mounds
Yam_mnds <- readRDS("../output_data/Yam_mnds.rds")
head(Yam_mnds)
```
# Bronze Age mounds from Toshko

Drazhevo - Height: 2.7 m; Diameter: 37.0 m; Land: pasture on the rocky area
Straldzha - Height: 4.0 m; Diameter: 50.0 m; Land: wines and pasture
Popovo - Height: 6.8 m; Diameter: 48.0 m; Land: wines and pasture

8345 Mogila village - Height: 3.2 m; Diameter: 37.6 m; Land: pasture on the rocky area 


```{r BA-faims}
# Filter out the BA mounds from the FAIMS data
bronze <- c(6009,8007,6010,8345,8346,8357, 8502, 8351, 9257)
BA <- Yam_mnds %>% 
  filter(TRAP %in% bronze)

# Add literature dimensions to mound 8345, which was excavated before survey 
BA$DiameterMax[5] <- 37.5
BA$HeightMax[5] <- 3.2



```

```{r BA-Todor}
# Add the few mounds excavated before TRAP coverage >> these should be pulled out of the AOR dataset to get the Height, Diameter and other dimensions..
extras <- data.frame(place = c("Drazhevo", 
                           "Straldzha",
                           "Popovo"),
                 Easting=c(455442,479522,479391),
                 Northing=c(4710935,4715730,4668279),
                 HeightMax=c(2.7,4.0,6.8),
                 DiameterMax = c(37,50,48),
                 LU_Around = c("Pasture","Perennial","Perennial"),
                 Type = c("Burial Mound","Burial Mound","Burial Mound"),
                 Source = c("Excavation","Excavation","Excavation"))
extrasf <- st_as_sf(extras, coords =c("Easting", "Northing"), crs = 32635)

library(plyr)
```


```{r BA-combo}
# Combine both BA datasets and spatialize
BApoints <- rbind.fill(BA, extrasf)
BAcoords <- rbind(st_coordinates(BA) ,st_coordinates(extrasf))
BApoints <- cbind(BApoints, BAcoords)
BApoints <- st_as_sf(BApoints, coords = c("X", "Y"), crs = 32635)
tail(BApoints)
```

## Look where these mounds are
```{r}
library(mapview)
mapview(Yam_mnds, cex = 2) + mapview(BApoints)
```

```{r}
plot(Y_region$geometry, main = "Excavated Bronze Age mounds (red circles) \n and other mound locations in Yambol")
plot(Yam_mnds$geometry, add = T);
plot(BApoints$geometry, pch = 16, col = "red", add =T)

```





# Extract promience and elevation data from raster
```{r}
Y_elev <- raster("../output_data/large/Yelev32635.tif")
Y_aspslope <- brick("../output_data/large/Yaspslope.tif")
```


# Extract raster values for BA mounds (elevation and prominence)
Ideally, when grabbing the excavated mounds, I get the information from the AOR reports, so have as complete a record of the morphology as possible
```{r sample-elev-aspect-slope-22}
# Mound data
BA_points <- BApoints %>% 
  dplyr::select(-elevAster) %>% 
  dplyr::select(-aspectAster) %>% 
  dplyr::select(-prom250mbuff) %>% 
  dplyr::select(-slopeAster)

# Sample elevations at mound locations
BApoints$elevAster <- raster::extract(Y_elev, st_coordinates(BApoints))

# Extract values from slope/aspect rasters created in script 00
BApoints$slopeAster <-  raster::extract(Y_aspslope$Yaspslope.1, st_coordinates(BApoints))

BApoints$aspectAster <-  raster::extract(Y_aspslope$Yaspslope.2, st_coordinates(BApoints))



# Calculate prominence 

library(FSA) # we need an additional library for the perc() function
     # check the fce is here
BApoints$prom250mbuff <- raster::extract(Y_elev,# raster containing elevation data
                        st_coordinates(BApoints), # centroids of mounds
                        buffer = 250, # actual buffer size in crs units, in this case 250m  or ca 22x22 cells around kernel
                        fun = function(x){perc(x,x[length(x)/2],"lt", na.rm = FALSE, digits = 2)})

```

## Plot the environ data
```{r}
?mapview
mapview(Yam_mnds, zcol = "prom250mbuff", label = "TRAP")
mapview(BApoints, zcol ="prom250mbuff")
```
## Tabulate the BA data

```{r}
summary(BApoints)
BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top)

```
make the values in table more visible
```{r}
library(formattable)

highlight <- color_tile("yellow","yellow")

formattable(BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top), list(
  area(col = 6, row = 2 ) ~ highlight,
  area(col = 6, row = 7 ) ~ highlight,
  area(col = 1, row = 2 ) ~ highlight,
  area(col = 1, row = 7 ) ~ highlight
  ))

```

While most mounds are in areas of high natural prominence, two exceptions confirm the rule: 6010 and 8351 are in low-lying non-prominent areas. The low scores may be caused by the coarse resolution of the 30m ASTER image which smooths over small-scale outcrops. The other option is that the mound-builders cared less about high location, sought dissociation from mounds on outcrops (already standing), or hoped to imbue the mound with prominence by raising its height.

### Height Boxplots
```{r}
boxplot(BApoints$HeightMax[BApoints$HeightMax>0], Yam_mnds$HeightMax[Yam_mnds$HeightMax>0], names = c("BA mounds", "all mounds"), main = "Maximum mound height")

```

### Elevations
```{r}
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(y=elevAster))  +
  geom_histogram(data = BApoints, aes(y=elevAster), fill = "yellow") +
  labs(title = "Elevation in Yambol and BA mounds(in yellow)",
       y = "Elevation (m)",
       x = "Count")
  theme_bw()
```
### Prominence comparison
```{r}
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(x=prom250mbuff))  +
  geom_histogram(data = BApoints, aes(x=prom250mbuff), fill = "yellow") +
  labs(title = "Prominence of Yambol relief and BA mounds (in yellow)",
       x = "Prominence (%)",
       y = "Count")
  theme_bw()

```



```{r}
BApoints %>% 
  ggplot(aes(x = LU_Around, y = HeightMax)) + 
  geom_violin(alpha = 0)+
  geom_jitter(color = "tomato")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  labs(x = "Feature type",
       y = "Height of feature",
       title = "Mound height by type")
```
### Elevation densities

To get elevation plotted as densities rather than histograms, one must rerun ElevationMC script.
```{r MC-densities, eval=FALSE}
ggplot() +
  geom_line(data = yambol_regionelev_densities,
            mapping = aes(x = Elevation,
                          y = Frequency),
            col = "lightgrey") +
  geom_ribbon(data = yambol_densities_wide,
              mapping = aes(x = Elevation,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              col = "darkgrey",
              alpha = 0.5) +
  geom_line(data = mounds_densities,
               mapping = aes(x = Elevation,
                             y = Frequency),
               color = "red", size = 2)+
  theme_bw()
```

## Intervisibility

Let's first see if we an create linestrings to later signal which mounds can *see* each other.
```{r}
# Test linestring creation on the first three BA mounds
coords <- cbind(st_coordinates(extrasf$geometry),st_coordinates(BA$geometry[1:3]))

# Test linestring creation from one origin and multiple target points. The coords object needs to be a matrix, but to cbind one to many coordinates the component columns need to be dataframes.
coords <- as.matrix(cbind(as.data.frame(st_coordinates(extrasf$geometry[2])),
                as.data.frame(st_coordinates(BA$geometry))))

lines <-  st_sfc(
     lapply(1:nrow(coords),
           function(i){
             st_linestring(matrix(coords[i,],ncol=2,byrow=TRUE))
           }))

st_crs(lines) <- st_crs(BA)
plot(lines) ; plot(extrasf$geometry[1], col = "red", add = T) ;
plot(BA$geometry, col = "green", add = T)


library(mapview)
mapview(lines)+mapview(BA$geometry)+ mapview(extrasf$geometry)

# https://stackoverflow.com/questions/65498300/how-to-efficiently-create-linestrings-from-points
# https://stackoverflow.com/questions/58150279/plotting-lines-between-two-sf-point-features-in-r
```
 Actual intervisibility means that all values in the cells along a line connecting two points are lower than those of the two points - there is a clear "line of sight"
Let's test such line of sight by extracting data out of raster cells between our BA points.

https://stackoverflow.com/questions/21841387/r-code-that-evaluates-line-of-sight-los-between-two-lat-lon-points 

https://gis.stackexchange.com/questions/272122/performing-viewshed-analysis-in-r
```{r}
cansee <- function(Y_elev, xy1, xy2, h1=0, h2=0){
### can xy1 see xy2 on DEM r?
### Y_elev is a DEM in same x,y, z units
### xy1 and xy2 are 2-length vectors of x,y coords
### h1 and h2 are extra height offsets
###  (eg top of mast, observer on a ladder etc)
    xyz = rasterprofile(r, xy1, xy2)
    np = nrow(xyz)-1
    h1 = xyz$z[1] + h1
    h2 = xyz$z[np] + h2
    hpath = h1 + (0:np)*(h2-h1)/np
    return(!any(hpath < xyz$z))
}

viewTo <- function(r, xy, xy2, h1=0, h2=0, progress="none"){
    ## xy2 is a matrix of x,y coords (not a data frame)
    require(plyr)
    aaply(xy2, 1, function(d){cansee(r,xy,d,h1,h2)}, .progress=progress)
}

rasterprofile <- function(r, xy1, xy2){
### sample a raster along a straight line between two points
### try to match the sampling size to the raster resolution
    dx = sqrt( (xy1[1]-xy2[1])^2 + (xy1[2]-xy2[2])^2 )
    nsteps = 1 + round(dx/ min(res(r)))
    xc = xy1[1] + (0:nsteps) * (xy2[1]-xy1[1])/nsteps
    yc = xy1[2] + (0:nsteps) * (xy2[2]-xy1[2])/nsteps
    data.frame(x=xc, y=yc, z=r[cellFromXY(r,cbind(xc,yc))])
}
```


# Excavated mounds from Yambol based on AORs

```{r load-AOR-google, eval = FALSE}
library(googlesheets4)
gs4_deauth()


general <- read_sheet("https://docs.google.com/spreadsheets/d/1l2glM1X8eiWFArunnnTG6iGdWUvcd7LVBYiFcbjBDJQ/edit#gid=1761342759&fvid=1870098839")
mound <- read_sheet("https://docs.google.com/spreadsheets/d/1l2glM1X8eiWFArunnnTG6iGdWUvcd7LVBYiFcbjBDJQ/edit#gid=1172661582", range = "MoundAttributes")
burial <- read_sheet("https://docs.google.com/spreadsheets/d/1l2glM1X8eiWFArunnnTG6iGdWUvcd7LVBYiFcbjBDJQ/edit#gid=1172661582", range = "BurialAttributes")

# here I can join them all and play.
```
Alternatively, and better perhaps, I can load the merged data in json format from \url{https://sciencedata.dk/index.php/apps/files/?dir=%2FSDAM_root%2FSDAM_data%2Fmounds&id=7813458&owner=648597%40au.dk} sciencedata.dk, unlist and work with
These Izvestia_df.json and AOR_df.json have been downloaded in data folder
Some guidance on unnesting:
https://stackoverflow.com/questions/38860380/unnesting-a-list-of-lists-in-a-data-frame-column

```{r eval = FALSE}
library(jsonlite)

json <- read_json("../data/AOR_df_2020-06-24.json", simplifyVector = TRUE)

json <- json %>% as_tibble()

# test
j <- json %>% 
  select(MoundID, Municipality,Region, Lat, Long, `Error radius(m)`, 
    LU_Around, MoundCover, Geomorphology, Prominence, MoundName, GT, RT,Condition, 
    `Source of Impact`, FirstStartDate, 
   MaxEndDate, FirstEnclosureType, 
    ) %>% 
  unnest(cols = c(MoundID, Municipality,Region, Lat, Long, `Error radius(m)`, 
    LU_Around, MoundCover, Geomorphology, Prominence, MoundName,GT, RT,Condition, 
    `Source of Impact`,  FirstStartDate, 
   MaxEndDate, FirstEnclosureType, 
     ))
j
# numbers in columns seem to be a problem:

BApotential <- j %>% 
  filter(Region == "Yambol") %>%
  filter(FirstStartDate < -2000)
  
BApotential


```
