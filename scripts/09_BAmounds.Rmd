---
title: "Bronze Age mounds - Are they different?"
author: "Adela Sobotkova"
date: "2022-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(raster)
library(tidyverse)
```

## Load 2009-2022 data
```{r load-mounds}
# Yambol mounds
Yam_mnds <- readRDS("../output_data/Yam_mnds.rds")
Y_region <- st_read("../data/YamRegion.shp")
head(Yam_mnds)
```
# Bronze Age mounds from Toshko

Drazhevo - Height: 2.7 m; Diameter: 37.0 m; Land: pasture on the rocky area
Straldzha - Height: 4.0 m; Diameter: 50.0 m; Land: wines and pasture
Popovo - Height: 6.8 m; Diameter: 48.0 m; Land: wines and pasture

8345 Mogila village - Height: 3.2 m; Diameter: 37.6 m; Land: pasture on the rocky area 


```{r BA-faims}
# Filter out the BA mounds from the FAIMS data
bronze <- c(6009,8007,6010,8345,8346,8357, 8502, 8351, 9257)
BA <- Yam_mnds %>% 
  filter(TRAP %in% bronze)

# Add literature dimensions to mound 8345, which was excavated before survey 
BA$DiameterMax[5] <- 37.5
BA$HeightMax[5] <- 3.2

```

```{r BA-Todor}
# Add the few mounds excavated before TRAP coverage >> these should be pulled out of the AOR dataset to get the Height, Diameter and other dimensions..
extras <- data.frame(place = c("Drazhevo", 
                           "Straldzha",
                           "Popovo"),
                 Easting=c(455442,479522,479391),
                 Northing=c(4710935,4715730,4668279),
                 HeightMax=c(2.7,4.0,6.8),
                 DiameterMax = c(37,50,48),
                 LU_Around = c("Pasture","Perennial","Perennial"),
                 Type = c("Burial Mound","Burial Mound","Burial Mound"),
                 Source = c("Excavation","Excavation","Excavation"))
extrasf <- st_as_sf(extras, coords =c("Easting", "Northing"), crs = 32635)

library(plyr)
```


```{r BA-combo}
# Combine both BA datasets and spatialize
BApoints <- rbind.fill(BA, extrasf)
BAcoords <- rbind(st_coordinates(BA) ,st_coordinates(extrasf))
BApoints <- cbind(BApoints, BAcoords)
BApoints <- st_as_sf(BApoints, coords = c("X", "Y"), crs = 32635)
tail(BApoints)
```

## Look where these mounds are
```{r}
library(mapview)
mapview(Yam_mnds, cex = 2) + mapview(BApoints)
```

```{r}
plot(Y_region$geometry, main = "Excavated Bronze Age mounds (red circles) \n and other mound locations in Yambol")
plot(Yam_mnds$geometry, add = T);
plot(BApoints$geometry, pch = 16, col = "red", add =T)

```





# Extract promience and elevation data from raster
```{r raster-extract}
Y_elev <- raster("../output_data/large/Yelev32635.tif")
Y_aspslope <- brick("../output_data/large/Yaspslope.tif")
```


# Extract raster values for BA mounds (elevation and prominence)
Ideally, when grabbing the excavated mounds, I get the information from the AOR reports, so have as complete a record of the morphology as possible
```{r sample-elev-aspect-slope-22}
# Mound data
BA_points <- BApoints %>% 
  dplyr::select(-elevAster) %>% 
  dplyr::select(-aspectAster) %>% 
  dplyr::select(-prom250mbuff) %>% 
  dplyr::select(-slopeAster)

# Sample elevations at mound locations
BApoints$elevAster <- raster::extract(Y_elev, st_coordinates(BApoints))

# Extract values from slope/aspect rasters created in script 00
BApoints$slopeAster <-  raster::extract(Y_aspslope$Yaspslope.1, st_coordinates(BApoints))

BApoints$aspectAster <-  raster::extract(Y_aspslope$Yaspslope.2, st_coordinates(BApoints))



# Calculate prominence 

library(FSA) # we need an additional library for the perc() function
     # check the fce is here
BApoints$prom250mbuff <- raster::extract(Y_elev,# raster containing elevation data
                        st_coordinates(BApoints), # centroids of mounds
                        buffer = 250, # actual buffer size in crs units, in this case 250m  or ca 22x22 cells around kernel
                        fun = function(x){perc(x,x[length(x)/2],"lt", na.rm = FALSE, digits = 2)})

```

## Plot the environ data
```{r}
?mapview
mapview(Yam_mnds, zcol = "prom250mbuff", label = "TRAP")
mapview(BApoints, zcol ="prom250mbuff")
```
## Tabulate the BA data

```{r}
summary(BApoints)
BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top)

```
make the values in table more visible
```{r}
library(formattable)

highlight <- color_tile("yellow","yellow")

formattable(BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top), list(
  area(col = 6, row = 2 ) ~ highlight,
  area(col = 6, row = 7 ) ~ highlight,
  area(col = 1, row = 2 ) ~ highlight,
  area(col = 1, row = 7 ) ~ highlight
  ))

```

While most mounds are in areas of high natural prominence, two exceptions confirm the rule: 6010 and 8351 are in low-lying non-prominent areas. The low scores may be caused by the coarse resolution of the 30m ASTER image which smooths over small-scale outcrops. The other option is that the mound-builders cared less about high location, sought dissociation from mounds on outcrops (already standing), or hoped to imbue the mound with prominence by raising its height.

### Height Boxplots
```{r}
boxplot(BApoints$HeightMax[BApoints$HeightMax>0], Yam_mnds$HeightMax[Yam_mnds$HeightMax>0], names = c("BA mounds", "all mounds"), main = "Maximum mound height")

```

### Elevations
```{r}
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(y=elevAster))  +
  geom_histogram(data = BApoints, aes(y=elevAster), fill = "yellow") +
  labs(title = "Elevation in Yambol and BA mounds(in yellow)",
       y = "Elevation (m)",
       x = "Count")
  theme_bw()
```
### Prominence comparison
```{r}
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(x=prom250mbuff))  +
  geom_histogram(data = BApoints, aes(x=prom250mbuff), fill = "yellow") +
  labs(title = "Prominence of Yambol relief and BA mounds (in yellow)",
       x = "Prominence (%)",
       y = "Count")
  theme_bw()

```



```{r}
BApoints %>% 
  ggplot(aes(x = LU_Around, y = HeightMax)) + 
  geom_violin(alpha = 0)+
  geom_jitter(color = "tomato")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  labs(x = "Feature type",
       y = "Height of feature",
       title = "Mound height by type")
```
### Elevation densities

To get elevation plotted as densities rather than histograms, one must rerun ElevationMC script.
```{r MC-densities, eval=FALSE}
ggplot() +
  geom_line(data = yambol_regionelev_densities,
            mapping = aes(x = Elevation,
                          y = Frequency),
            col = "lightgrey") +
  geom_ribbon(data = yambol_densities_wide,
              mapping = aes(x = Elevation,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              col = "darkgrey",
              alpha = 0.5) +
  geom_line(data = mounds_densities,
               mapping = aes(x = Elevation,
                             y = Frequency),
               color = "red", size = 2)+
  theme_bw()
```


