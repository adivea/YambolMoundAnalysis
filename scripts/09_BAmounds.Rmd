---
title: "Bronze Age mounds - Are they different?"
author: "Adela Sobotkova"
date: "2022-11-17"
output: html_document
---

This script summarizes environmental information on the Bronze Age burial mounds in the Yambol Province, and plots 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(raster)
library(plyr)
library(tidyverse)
```

## Load 2009-2022 mound data
```{r load-mounds}
# Yambol mounds
Yam_mnds <- readRDS("../output_data/Yam_mnds.rds")
Y_region <- st_read("../data/YamRegion.shp")
head(Yam_mnds)
```
## Extract excavated Bronze Age mounds

We now need to separate out the mounds originating from the Bronze Age as confirmed by excavation. 
First, let's filter mounds by TRAP id from the TRAP survey mound dataset and second, we will create spatial data for the excavated mounds.

```{r BA-faims}
# Filter out the BA mounds from the FAIMS data
bronze <- c(6009,8007,6010,8345,8346,8357, 8502, 8351, 9257) # Toshko provided these TRAP numbers
BA <- Yam_mnds %>% 
  filter(TRAP %in% bronze)

# Add literature dimensions to mound 8345, which was excavated before survey 
BA$DiameterMax[5] <- 37.5
BA$HeightMax[5] <- 3.2

```
I tested this chunk with mound 6011 instead of 6010, because the image for 6011 looks excavated but its prominence was less than 6% as it sits on a flat ridge 

Todor specified the coordinates and other data for the excavated mounds as:
Drazhevo - Height: 2.7 m; Diameter: 37.0 m; Land: pasture on the rocky area
Straldzha - Height: 4.0 m; Diameter: 50.0 m; Land: wines and pasture
Popovo - Height: 6.8 m; Diameter: 48.0 m; Land: wines and pasture
8345 Mogila village - Height: 3.2 m; Diameter: 37.6 m; Land: pasture on the rocky area 

```{r BA-Todor}
# Add the few mounds excavated before TRAP coverage >> these can also be pulled out of the AOR dataset
extras <- data.frame(place = c("Drazhevo", 
                           "Straldzha",
                           "Popovo"),
                 Easting=c(455442,479522,479391),
                 Northing=c(4710935,4715730,4668279),
                 HeightMax=c(2.7,4.0,6.8),
                 DiameterMax = c(37,50,48),
                 LU_Around = c("Pasture","Perennial","Perennial"),
                 Type = c("Burial Mound","Burial Mound","Burial Mound"),
                 Source = c("Excavation","Excavation","Excavation"))
extrasf <- st_as_sf(extras, coords =c("Easting", "Northing"), crs = 32635)

```

Combine the excavated and survey data
```{r BA-combo}
# Combine both BA datasets and spatialize
BApoints <- rbind.fill(BA, extrasf) # combine the attributes by row
BAcoords <- rbind(st_coordinates(BA) ,st_coordinates(extrasf)) # combine coordinates
BApoints <- cbind(BApoints, BAcoords) # add coordinate column to the attributes
BApoints <- st_as_sf(BApoints, coords = c("X", "Y"), crs = 32635) # convert to a simple feature
tail(BApoints)
```

## Map the mounds

Compare the excavated Bronze Age mound location with the other Yambol mounds
```{r}
library(mapview)
mapview(Yam_mnds, cex = 2) + mapview(BApoints) #using just the coordinates
```

```{r}
plot(Y_region$geometry, main = "Excavated Bronze Age mounds (red circles) \n and other mound locations in Yambol")
plot(Yam_mnds$geometry, add = T);
plot(BApoints$geometry, pch = 16, col = "red", add =T)

```

## Extract prominence and elevation data from raster
Location alone does not tell us much about the mounds. Let's extract additional values from the underlying 30m res ASTER imagery so we can compare the mounds' location formally.

We first load the ASTER layer and a derived slope and aspect raster.
```{r raster-load}
Y_elev <- raster("../output_data/large/Yelev32635.tif")
Y_aspslope <- brick("../output_data/large/Yaspslope.tif")
```

Next, we extract values from raster at mound locations. 

An  alternative to extraction is to, when grabbing the excavated mounds, get the information from the AOR reports, so as to have as complete a record of the morphology as possible. Here I enrich the BA mound data with environmental information extracted from ASTER raster. I simply overwrite the data where it exists so as to be consistent
```{r sample-elev-aspect-slope-22}
# Streamline mound data by killing and regenerating some columns. Commented out, as I overwrite them 
# BApoints <- BApoints %>% 
#   dplyr::select(-elevAster) %>% 
#   dplyr::select(-aspectAster) %>% 
#   dplyr::select(-prom250mbuff) %>% 
#   dplyr::select(-slopeAster)

# Sample elevations at mound locations
BApoints$elevAster <- raster::extract(Y_elev, st_coordinates(BApoints))

# Extract values from slope/aspect rasters created in script 00
BApoints$slopeAster <-  raster::extract(Y_aspslope$Yaspslope.1, st_coordinates(BApoints))

BApoints$aspectAster <-  raster::extract(Y_aspslope$Yaspslope.2, st_coordinates(BApoints))



# Calculate prominence 

library(FSA) # we need an additional library for the perc() function
     # check the fce is here
BApoints$prom250mbuff <- raster::extract(Y_elev,# raster containing elevation data
                        st_coordinates(BApoints), # centroids of mounds
                        buffer = 250, # actual buffer size in crs units, in this case 250m  or ca 22x22 cells around kernel
                        fun = function(x){perc(x,x[length(x)/2],"lt", na.rm = FALSE, digits = 2)})

```

## Plot BA mounds with the prominence
In the next chunk we view the relative visual control of the surrounding terrain (prominence measures the percentage of area visible from mound within 360 degrees and 250m radius around the mound), and the accessibility. TRI is topographic ruggedness representing another measure of relative elevation above the terrain (it is only present in survey mounds ad needs to be calculated for all excav.mounds)
```{r mapview-prom-BA}
library(leafsync)

pr <- mapview(BApoints, zcol ="prom250mbuff")
tri <- mapview(BApoints, zcol = "TRI")
sync(pr, tri)
```
## Tabulate and summarize the Bronze Age mound attributes
Let us now look at some attributes of interest such as morphology, elevation, slope, etc.
```{r table-BA}
library(formattable)
formattable(BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top))

```
We might as well summarize these values to get an idea of the range present in BA mounds
```{r}
summary(BApoints[,c(6:7,12:18)])
```

An average Bronze Age mound has the height of 3m, diameter around 30 m, the prominence mean of 66% and prominence median of 71%. TRI is around 1.35 and roughness at 4.  We may be able to extend these findings to the other Yambol mounds.

Most mounds are located in pastures(5) or rock outcrops with sparse grass cover, some scrub(2) and occasionally vineyards(2) and agricultural fields(2).
```{r}
BApoints %>% 
  st_drop_geometry() %>% 
  group_by(LU_Around) %>% 
  tally() %>% 
  arrange(desc(n))

BApoints %>% 
  st_drop_geometry() %>% 
  group_by(LU_Top) %>% 
  tally() %>% 
  arrange(desc(n))

```
As for the previous summary of attributes, the means are always deceptive, and small errors might cause big deviations (I think 6010 might be confused with 6011). The prominence mean, for example, might be higher if the two low-prominence mounds were not included (6010 and 8351)

```{r table-prom}
library(formattable)

highlight <- color_tile("yellow","yellow")

formattable(BApoints %>% 
  st_drop_geometry() %>% 
  dplyr::select(TRAP, HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff, LU_Around, LU_Top), list(
  area(col = 6, row = 2 ) ~ highlight,
  area(col = 6, row = 7 ) ~ highlight,
  area(col = 1, row = 2 ) ~ highlight,
  area(col = 1, row = 7 ) ~ highlight,
  area(col = 6, row = 11 ) ~ highlight,
  area(col = 1, row = 11) ~ highlight
  ))

```

```{r}
plot(BApoints %>%
       st_drop_geometry() %>% 
       dplyr::select(HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff))

plot(Yam_mnds %>%
       st_drop_geometry() %>% 
       filter(Type == "Burial Mound") %>% 
       dplyr::select(HeightMax, DiameterMax, elevAster, slopeAster, prom250mbuff))
```


While most mounds are in areas of high natural prominence, two exceptions confirm the rule: 6010 and 8351 are in non-prominent areas. The low (~30%) scores may be caused by the coarse resolution of the 30m ASTER image which smooths over small-scale outcrops. In case of [6010](https://drive.google.com/file/d/1FA0u-wfDa833nJ3AJsMz-YrGdUVZaKj9/view?usp=sharing) /[6011](https://drive.google.com/file/d/0B-3SQVhaYJT8akZxX2s2aDNVMTQ/view?usp=sharing&resourcekey=0--m1nV2vPcDUaUMz9_-NCnw) and [8351](https://drive.google.com/file/d/1z89LtciUJxqdxofzierwLEaiQLlb7tHL/view?usp=sharing), the 250m radius disadvantages mounds located on elevated platforms. These may have reasonable visibility of the surrounding landscape but are either on a lower upslope or flat ridge (6011) which lowers the results within the 250m radius. The other option is that the mound-builders cared less about high location, sought dissociation from mounds on outcrops (already standing), or hoped to imbue the mound with prominence by raising its height.

## Predict mounds on the basis of prominence and TRI
The mean and median prominence values for BA mounds can provide a guide for other potentially Bronze Age mounds (if we choose a single factor)
The following map will show the mounds within the Yambol dataset that have prominence higher than the mean of 66% (303 features) and whose topographic ruggedness is over the mean of 1.35 (72). The lighter the point color the higher their prominence and the more probable their Bronze Age origin 
```{r}
library(mapview)
library(leafsync)
m71 <- Yam_mnds %>% 
  filter( prom250mbuff > 71 & Type == "Burial Mound" & TRI >1.35) %>% 
  mapview(zcol = "prom250mbuff")
m66 <- Yam_mnds %>% 
  filter(prom250mbuff > 66 & Type == "Burial Mound") %>% 
  mapview(zcol = "prom250mbuff")
BA <- mapview(BApoints)
sync(m66,m71, BA, ncol=3)
```
## Predict BA mounds on basis of Landuse and size
Over 3 m high and over 150masl, over 66% and 1.35 TRI
```{r}
withTRI <- Yam_mnds %>% 
  filter(HeightMax > 3 & 
           elevAster > 150 &
        # DiameterMax > 30 &&
        # LU_Around == "Scrub" | LU_Around == "Pasture" &&
        #   LU_Top == "Pasture" | LU_Top == "Scrub" &&
         prom250mbuff > 66 &
         TRI > 1.35 &
         Type == "Burial Mound" ) %>% 
  mapview()
withTRI


```

Over 3 m high and over 170masl and 71% prominence.
```{r}
library(mapview)
library(leafsync)
noTRI <- Yam_mnds %>% 
  filter(HeightMax > 3 & 
           elevAster > 170 &
        # DiameterMax > 30 &&
        # LU_Around == "Scrub" | LU_Around == "Pasture" &&
        #   LU_Top == "Pasture" | LU_Top == "Scrub" &&
         prom250mbuff > 66 &
        # TRI > 1.35 &&
         Type == "Burial Mound" ) %>% 
          mapview()
           
BA <- mapview(BApoints)
sync(BA,withTRI,noTRI, ncol=3)

```

## Table the potential BA mounds

```{r}
potentialBA <- Yam_mnds %>% 
              st_drop_geometry() %>% 
  filter(HeightMax > 3 & 
           elevAster > 170 &
         prom250mbuff > 66 &
         Type == "Burial Mound" )
#write.csv(potentialBA, "../output_data/potentialBA.csv")

formattable(potentialBA)

```

## Height and Elevation comparisons between BA and Yambol mounds

### Height Boxplots
```{r}
hist(BApoints$elevAster)
boxplot(BApoints$HeightMax[BApoints$HeightMax>0], Yam_mnds$HeightMax[Yam_mnds$HeightMax>0], names = c("BA mounds", "all mounds"), main = "Maximum mound height")

```

### Elevations
```{r}

#png(filename="../output_data/mndBAYam.png", width=300, height=450)
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(x=elevAster,  fill = "All"), binwidth = 10)  +
  geom_histogram(data = BApoints, aes(x=elevAster,  fill = "Bronze Age"),  binwidth = 10) +
  labs(title = "Mound elevations in Yambol",
       x = "Elevation (m)",
       y = "Count")+
  theme_bw()+
  scale_fill_grey( name = "Mounds") + 
  theme(legend.position = "bottom")#
```

### Prominence comparison
```{r}
Yam_mnds %>% 
  ggplot() +
  geom_histogram(aes(x=prom250mbuff), binwidth = 2)  +
  geom_histogram(data = BApoints, aes(x=prom250mbuff), fill = "yellow", binwidth = 2) +
  labs(title = "Prominence of Yambol relief and BA mounds (in yellow)",
       x = "Prominence (%)",
       y = "Count")+
  theme_bw()

```



```{r}
BApoints %>% 
  ggplot(aes(x = LU_Around, y = HeightMax)) + 
  geom_violin(alpha = 0)+
  geom_jitter(color = "tomato")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  labs(x = "Feature type",
       y = "Height of feature",
       title = "Mound height by type")
```
### Prominence densities

To get prominence plotted as densities rather than histograms, one must rerun ProminenceMC script.
```{r MC-densities, eval=FALSE}

# Calculate the mound densities

library(foreach)
library(purrrlyr)

#note the exposition pipe operator $, which works as dataframe$variable
BAmounds_densities <- BApoints %$%  
  prom250mbuff %>%
  density(from = 0,
            to = 100,
            n = 1201) %>% 
   broom::tidy() %>%
   tibble::as_tibble() %>%
  dplyr::mutate(y = y * 1201) %>%
  dplyr::rename(Prominence = x,
                Frequency = y)

ggplot() +
  geom_line(data = yambol_region_densities,
            mapping = aes(x = Prominence,
                          y = Frequency),
            col = "lightgrey") +
  geom_ribbon(data = yambol_densities_wide,
              mapping = aes(x = Prominence,
                            ymin = `Lower CI`,
                            ymax = `Upper CI`),
              col = "darkgrey",
              alpha = 0.5) +
  geom_line(data = mounds_densities,
               mapping = aes(x = Prominence,
                             y = Frequency),
               color = "red", size = 2)+
  geom_line(data = BAmounds_densities,
               mapping = aes(x = Prominence,
                             y = Frequency),
               color = "pink", size = 2)+
  theme_bw()+
  labs(x = "Topographic Prominence (%)")
```


