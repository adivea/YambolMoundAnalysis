---
title: "Looking at mound Vulnerability"
author: "Adela Sobotkova"
date: "28 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Methodology
We apply an ordered logit model to determine the vulnerability of burial mounds to anthropogenic threats in the Yambol province. This model has been developed in a previous study of the Kazanlak Valley in central Bulgaria. However, as the study areas differ in their location, environment, as well as level of development, we expect to see differences in mound vulnerability and predicted decline. While field observations underscored looting as a massive factor, subjectively looting felt less intense in Yambol than in Kazanlak (Eftimoski et al. 2017). Agricultural and military activity (due to proximity to Cold War border) competed for place among the principal factors contributing to the ubiquitous degradation of the mounds we saw during archaeological surveys (Sobotkova and Weissova 2020). Choosing these factors over others constituted a ‘perceptive’ initial risk assessment (Vojinovic et al. 2016). 

Based on this intuition, we propose a number of hypotheses:

1. The ploughing, harrowing, and removal of obstacles from fields associated with annual agriculture damage mounds, so conversion FROM other land-use type TO annual agriculture would tend to damage mounds more (increase the Condition score where 1= pristine, 5 = near extinct).
2. Proximity to national border formerly the cold-war border will increase mound damage due to their remake as bunkers. Ie. map symbols indicating mounds will turn out to be bunkers and other defensive features in the field.  
3. Proximity to a city, town, or village would contribute to damage, since it is a proxy for destructive peri-urban activities like development, construction and casual looting (cf. Agapiou et al. 2015).
4. Looters would preferentially target larger mounds and inflict greater archaeological damange (ArchaeologicalImpact) and lesser volume damage(CRM column), since large mounds typically contain richer burials than small ones. We concede that small mounds are more susceptible to agricultural damage, but thought that damage to large mounds from looting would prove more significant (cf. Stone 2008, 67-68).
5. Looters operate in a spatially contiguous area and mound condition will be spatially correlated.

The analysis here will test our subjective perceptions of risk. We use a relatively large number of observations (ca 1000) to model relationships between mound condition and elevation, mound size, surrounding land use (including annual agriculture, perennial agriculture, pasture, or forest), and distance to the nearest urban and national boundary. 
Five specific changes were then simulated:
- conversion of all forest to annual agriculture;
- conversion of all forest to pasture;
- conversion of all pasture to annual agriculture;
- an increase in distance of one standard deviation (XXX m) from the nearest edge of a city, town, or village.
- an increase in distance of one standard deviation (XXX m) from the southern border / southern aspect / location in 30m border zone?
- regression of Condition over Height (or other proxy of size)
- spatial autocorrelation of Condition is tested (location or relief?)


## Landuse

‘Land-use’ represents how land was used around the mound at the time of survey with categorical values of pasture, forest, annual agriculture (arable land), perennial agriculture, scrub, and urban (Fig. 4). Mounds were most frequent in agricultural fields, which [comprised XXX% of the Yambol province (XX of 3355 km2), and ] contained 54.2% of the mounds (640). Conversely, grasslands - whether pastures or overgrown field-divisions - [comprised YYY% of the Yambol province (XX of 3355 km2), but] contained 30.4% of the mounds (359). Scrub surrounded 8.6% mounds (101) , while all the remaining landuse categories together contained the remaining 6.5% of mounds (80). 

Qualify! [Put another way, the density of mounds per sq km was high in pasture, but low in annual agriculture (26.9 vs 2.3 respectively). Any change from pasture to annual agriculture, therefore, may affect a large number of mounds. Scrub and Perennial agriculture were retained in the model to improve estimation of logit coefficients (see 2.3 below), but no attempt was made to simulate land-use transitions on such a small number of mounds (n=99 and 15 respectively). The remaining types of Forest (n=52), and Other (n = 11) can be grouped under ‘Other’ in Fig. 4) due to their low incidence (less than 15% of all mounds altogether).


```{r, echo = FALSE}
library(tidyverse)
library(sf)
```
# Let's review the dataset
```{r data}

# Load in the master_sp from shapefile or inherit from 07_EnrichSpatial.R
# master_sp <- st_read("../output_data/enriched_all.shp")
master_sp <- st_read("../../MoundMerging2020/output_data/mounds_dd_later.geojson")

# Liberal dataset
master_sp %>%
  group_by(Type) %>%
  tally()

# Most conservative dataset
master_sp %>% 
  filter(Type == "Burial Mound" | Type == "Extinct Burial Mound") 
```



# Fixing landuse 

Lets review the most common categories of landuse AROUND mounds

```{r}
master_sp %>% 
  st_drop_geometry() %>% 
  filter(Type == "Burial Mound" | Type == "Extinct Burial Mound") %>%   group_by(LU_Around) %>% 
  tally() %>% 
  mutate(perc = round(n/sum(n)*100, 2)) %>%  # this will not run after I once have spread it.
  arrange(desc(n))

```
 Annual agriculture, pasture and scrub are the most common categories, with forest perhaps the last meaningful category. Perennial agriculture, other and urban might be best merged into Other, or perennial with agriculture and the rest in Other. 
 
 The situation with landuse ON TOP of mounds looks similar.
```{r}
master_sp %>% 
  st_drop_geometry() %>%
  filter(Type == "Burial Mound" | Type == "Extinct Burial Mound") %>% 
  group_by(LU_Top) %>% 
  tally() %>% 
  mutate(perc = round(n/sum(n)*100, 2)) %>% 
  arrange(desc(n))
```
Lets make each landuse category into a variable with pivot_wider() function. Some of the categories should perhaps be merged 

```{r}
m_vuln <- master_sp %>%
  st_drop_geometry() %>%
  filter(Type == "Burial Mound" | Type == "Extinct Burial Mound") %>% 
  mutate(n=1) %>% 
  pivot_wider(names_from = LU_Around, values_from= n, values_fill = list(n = 0)) %>% 
  rename(Annual = 'Annual agriculture', Perennial = 'Perennial agriculture', OtherLU = Other)
```

It might be a good idea to merge the small categories into larger ones, especially where is similar relationship (Annual and Perennial, Urban and Other)
```{r}
m_vuln <- m_vuln %>% 
  mutate(Annual = Annual + Perennial, 
         OtherLU = Urban +  OtherLU) %>% 
  select(-one_of('Urban', 'Perennial'))
  
```

# Eliminate unnecessary columns

```{r}
m_vuln <- m_vuln %>% 
  select(-one_of('TopoID', 'Note'))
```

# Creating 'Robbed' column
I want to see whether mound getting looted variable depends on any of the distance or landuse independent variables. 
```{r}
levels(factor(m_vuln$PrincipalSourceOfImpact))

m_vuln <- m_vuln %>%
  mutate(Robbed = str_extract(PrincipalSourceOfImpact, "Loot")) %>%
  mutate(Robbed = case_when(is.na(Robbed) ~ "No",
                            Robbed == "Loot" ~ "Yes"))

```

# Add distances to town and Bulgarian border in kms
if it is easier for the logit output...
```{r}
m_vuln$distBGkm <-m_vuln$distBG/1000 
m_vuln$distTownkm <-m_vuln$distTown/1000 
```

# Condition 
We need to streamline a bit the Condition variable, clarifying NAs and recoding number 6 as it should be 1-5 Likert scale. Beware that this code will clear uncertainty such as 3? or 2? , where condition was hard to gauge in the field.
```{r}
# This newly added chunk reclassifies the values in master$Condition, which means the following effect analysis needs to be adjusted. See if it is easier to leave as was with 0 marking NAs.

levels(factor(m_vuln$Condition))

m_vuln <- m_vuln %>%
  mutate(Condition = str_extract(Condition, "\\d")) %>%
  mutate(Condition = case_when(Condition == 0 ~ "NA",
                               Condition == 6 ~ "5",
                               Condition != 0 ~ Condition))
m_vuln$Condition <- as.numeric(m_vuln$Condition)
unique(m_vuln$Condition)
```

# Print out the result
```{r}
write_csv(m_vuln, "../output_data/vulnerability.csv")
```



# Internal Review for Adela ONLY -  SKIP UNTIL LOGIT on line 178
Lets review the Condition. It, too, might need some aggregation of categories (e.g. 1 and 2), but for now I am leaving it in the original state.
```{r}
# m_effect <- m_effect %>%
#   mutate(effect = str_extract(Condition, "[0-9]"))

m_vuln %>%
  filter(!is.na(Condition)) %>% # 90 features have 0 - No observation in Condition
  group_by(Type, Condition) %>% 
  tally()
```

## Final review of Condition - sanity checks with photographs! 
Lets review these features where effect/condition is marked as 0 - No observation possible. Are these typos or truly NAs? Well, they do look like NAs, so lets' exclude them in the future. We might also want to focus on mounds only
```{r}
master %>%
  filter(effect == 0 & Type == "Burial Mound")
```
Mound 9548 should have effect == 6, given the pasture landuse. All others should stay as NAs
```{r}
master %>%
  filter(effect == 0) %>% 
  filter(Type == "Extinct Burial Mound" | Type == "Uncertain Mound")
```
All but 9626 should have effect == 6


## Another way of prepping Condition if reading in another dataset

Let's check the condition of mounds depending on landuse. 
- select only mounds
- collate effect into 2-3 categories

```{r , eval=FALSE, echo = FALSE}
mounds2 <- masterall %>% 
  mutate(effect = case_when(effect == "1" ~ "2",
                     effect == "6" ~ "5",
                     effect %nin% c("1","6") ~ effect)) %>% 
  filter(grepl("Mound", Type)) %>% 
  rename(distTown = NEAR_DIST, TownX = NEAR_X, TownY = NEAR_Y)

mounds2 %>% 
  filter(effect != 0) %>% 
  group_by(effect) %>% 
  tally()

```

# Logit model - basically reproducing Eftimoski's logit from Kazanlak
```{r}
library(haven)
library(MASS)
require(ordinal)

```

```{r logit}
# Using polr() function from the MASS library 
logittable1 <- polr(factor(Condition) ~ Annual + Scrub + Pasture + Forest + Robbed + distTownkm + distBGkm, data = m_vuln, Hess = TRUE)

logittable1

```

```{r probit}
probit<-polr(factor(Condition) ~ Annual + Scrub + Pasture + 
    Forest + Robbed + distTown + distBG, data = m_vuln)
probit

```

Lets try plain glm
```{r}
test<-glm(factor(Condition) ~ Annual + Scrub + Pasture + Forest + Robbed + distTown, family= "binomial", data = m_vuln) 
summary(test)
```




